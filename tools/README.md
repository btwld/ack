# Ack Development Tools

This directory contains internal development tools and documentation for the Ack library, including JSON Schema validation and API compatibility checking.

## 📁 Directory Structure

- `api-baseline.sh` - API compatibility management script
- `jsonschema-validator.js` - JSON Schema Draft-7 validation tool
- `docs/` - **Internal development documentation** (not published)
- `test-fixtures/` - Test data and configurations

## 📚 Documentation

- **[Development Guide](../DEVELOPMENT.md)** - Complete development workflows and API compatibility guide
- **[API Reference](docs/API_REFERENCE.md)** - Quick command reference for API compatibility tools

> **Note**: For comprehensive development information, see the main [DEVELOPMENT.md](../DEVELOPMENT.md) guide.

## Setup

Install Node.js dependencies:

```bash
cd tools
npm install
```

## JSON Schema Validator

The `jsonschema-validator.js` script validates that Ack-generated JSON schemas are valid JSON Schema Draft-7 specifications using industry-standard JSON Schema validation.

### Usage

#### Single Schema Validation

Validate a single JSON schema specification:

```bash
node jsonschema-validator.js validate-schema --schema schema.json --output results.json
```

#### Batch Schema Validation

Run multiple schema validation tests from a configuration file:

```bash
node jsonschema-validator.js validate-batch --input batch-config.json --output results.json
```

#### Legacy Mode

For backward compatibility:

```bash
node jsonschema-validator.js schema.json [output.json]
```

### Test Fixtures

The `test-fixtures/` directory contains:

- `schemas/` - Sample JSON schemas generated by Ack
- `data/valid/` - Valid test data that should pass validation
- `data/invalid/` - Invalid test data that should fail validation
- `batch-config.json` - Configuration for batch testing

### Integration with Dart Tests

The validator can be called from Dart tests to create golden file tests that ensure Ack's validation behavior matches JSON Schema validation standards.

Example Dart test:

```dart
test('JSON Schema compatibility for user schema', () async {
  // Generate JSON schema from Ack schema
  final ackSchema = Ack.object({
    'name': Ack.string.minLength(2),
    'email': Ack.string.email(),
  }, required: ['name', 'email']);
  
  final jsonSchema = JsonSchemaConverter(schema: ackSchema).toSchema();
  
  // Write schema to temp file
  final schemaFile = File('temp/user-schema.json');
  await schemaFile.writeAsString(jsonEncode(jsonSchema));
  
  // Run JSON Schema validation
  final result = await Process.run('node', [
    'tools/jsonschema-validator.js',
    'batch',
    '--input', 'tools/test-fixtures/batch-config.json',
    '--output', 'temp/jsonschema-results.json'
  ]);

  expect(result.exitCode, equals(0));

  // Compare with golden file
  final results = jsonDecode(await File('temp/jsonschema-results.json').readAsString());
  await expectLater(results, matchesGoldenFile('jsonschema-validation-results.golden'));
});
```

### Output Format

The validator outputs structured JSON results:

```json
{
  "timestamp": "2024-01-01T00:00:00.000Z",
  "tests": [
    {
      "name": "user-schema-validation",
      "schemaPath": "schemas/user-schema.json",
      "validData": [
        {
          "valid": true,
          "errors": [],
          "dataName": "user-valid-1.json"
        }
      ],
      "invalidData": [
        {
          "valid": false,
          "errors": [
            {
              "instancePath": "",
              "schemaPath": "#/required",
              "keyword": "required",
              "params": {"missingProperty": "email"},
              "message": "must have required property 'email'"
            }
          ],
          "dataName": "user-invalid-missing-required.json"
        }
      ],
      "summary": {
        "totalValid": 3,
        "totalInvalid": 4,
        "expectedValid": 3,
        "expectedInvalid": 4,
        "correctValidations": 7,
        "incorrectValidations": 0
      }
    }
  ]
}
```

## Adding New Test Cases

1. Add your JSON schema to `test-fixtures/schemas/`
2. Add valid test data to `test-fixtures/data/valid/`
3. Add invalid test data to `test-fixtures/data/invalid/`
4. Update `test-fixtures/batch-config.json` to include your new test case
5. Run the validator to verify everything works

## API Compatibility Checking

The `api-baseline.sh` script helps manage API compatibility checking using `dart_apitool` for development and release workflows.

### Usage

#### Create API Baseline

Create a baseline from the current API state:

```bash
./tools/api-baseline.sh create
# or via melos
melos api:baseline:create
```

#### Check Changes

Check current API against the baseline:

```bash
./tools/api-baseline.sh check
# or via melos
melos api:baseline:check
```

#### Generate Report

Generate a detailed markdown report of API changes:

```bash
./tools/api-baseline.sh report
# or via melos
melos api:baseline:report
```

#### Check Against Release

Compare current API with the last published release:

```bash
./tools/api-baseline.sh release
# or via melos
melos api:release:check
```

### Development Workflow

1. **Start Development**: Create baseline before making changes
   ```bash
   melos api:baseline:create
   ```

2. **During Development**: Check changes frequently
   ```bash
   melos api:baseline:check
   ```

3. **Before Release**: Validate against last release
   ```bash
   melos api:release:check
   ```

4. **Generate Reports**: Create detailed analysis
   ```bash
   melos api:baseline:report
   ```

## Integration with Melos

Both tools are integrated into the Melos workflow:

- **JSON Schema Validation**: `validate-jsonschema` scripts
- **API Compatibility**: `api:*` scripts

See the main project's `melos.yaml` for all available commands.
