# SchemaModel API

This document describes the SchemaModel API in Ack, which provides a way to create schema-based models with automatic validation.

## Overview

The `SchemaModel` class is a base class for creating schema-based models that can validate data against a schema. It provides a simple and intuitive API for creating, validating, and converting data to models.

## Key Features

- **Automatic Validation**: Validation happens automatically when a SchemaModel is created
- **Simple Error Handling**: Easy access to validation errors through `isValid` and `getErrors()`
- **Type Safety**: Uses `Object?` instead of `dynamic` for better type safety
- **Fluent API**: Intuitive API for creating and using schema models

## Basic Usage

```dart
// Define a schema model
class UserSchema extends SchemaModel<User> {
  UserSchema(Object? data) : super(data);

  @override
  AckSchema getSchema() {
    return Ack.object({
      'name': Ack.string.minLength(2),
      'email': Ack.string.isEmail(),
      'age': Ack.int.min(0).nullable(),
    }, required: ['name', 'email']);
  }

  @override
  User toModel() {
    if (!isValid) {
      throw AckException(getErrors()!);
    }
    
    return User(
      name: getValue<String>('name')!,
      email: getValue<String>('email')!,
      age: getValue<int?>('age'),
    );
  }
}

// Using the schema model
final userData = {
  'name': 'John Doe',
  'email': 'john@example.com',
  'age': 30,
};

final userSchema = UserSchema(userData);

// Check if the schema is valid
if (userSchema.isValid) {
  // Convert to model
  final user = userSchema.toModel();
  print('User: ${user.name}, ${user.email}, ${user.age}');
} else {
  // Handle validation errors
  print('Validation errors: ${userSchema.getErrors()}');
}
```

## API Reference

### Constructor

```dart
SchemaModel(Object? data)
```

Creates a new SchemaModel instance with the given data. The data can be any object, but it's typically a `Map<String, dynamic>`. Validation happens automatically during construction.

### Methods

#### `AckSchema getSchema()`

This abstract method must be implemented by subclasses. It should return an `AckSchema` that defines the validation rules for the model.

#### `T toModel()`

This abstract method must be implemented by subclasses. It should convert the validated data to a model of type `T`. It's recommended to check `isValid` before converting to a model and throw an `AckException` if the data is invalid.

#### `Object? getValue<T>(String key)`

Gets a value from the data by key, cast to the specified type `T`. Returns `null` if the key doesn't exist or the value can't be cast to the specified type.

#### `Map<String, dynamic> toMap()`

Returns the data as a `Map<String, dynamic>`. This is useful for serializing the data to JSON.

#### `SchemaError? getErrors()`

Returns the validation errors if the data is invalid, or `null` if the data is valid.

### Properties

#### `bool isValid`

Returns `true` if the data is valid according to the schema, `false` otherwise.

## SchemaRegistry

The `SchemaRegistry` class provides a way to register schema models and create them dynamically based on model types.

### Registering a Schema

```dart
// Register a schema factory
SchemaRegistry.register<User, UserSchema>((data) => UserSchema(data));
```

### Creating a Schema

```dart
// Create a schema using the factory
final schema = SchemaRegistry.createSchema(User, userData);
```

## Migration Guide

If you're migrating from an older version of Ack, here are the key changes to the SchemaModel API:

### Before

```dart
class UserSchema extends SchemaModel<User> {
  UserSchema(Map<String, dynamic> data) : super(data);

  static UserSchema parse(Map<String, dynamic> data) {
    final result = schema.validate(data);
    if (result.isFail) {
      throw AckException(result.getError());
    }
    return UserSchema(data);
  }

  @override
  SchemaResult validate() {
    return schema.validate(toMap());
  }

  @override
  User toModel() {
    return User(
      name: getValue<String>('name')!,
      email: getValue<String>('email')!,
      age: getValue<int?>('age'),
    );
  }

  @override
  void initialize() {
    // Initialize code here
  }
}

// Using the schema model
final userSchema = UserSchema.parse(userData);
final validationResult = userSchema.validate();
if (validationResult.isOk) {
  final user = userSchema.toModel();
}
```

### After

```dart
class UserSchema extends SchemaModel<User> {
  UserSchema(Object? data) : super(data);

  @override
  AckSchema getSchema() {
    return Ack.object({
      'name': Ack.string.minLength(2),
      'email': Ack.string.isEmail(),
      'age': Ack.int.min(0).nullable(),
    }, required: ['name', 'email']);
  }

  @override
  User toModel() {
    if (!isValid) {
      throw AckException(getErrors()!);
    }
    
    return User(
      name: getValue<String>('name')!,
      email: getValue<String>('email')!,
      age: getValue<int?>('age'),
    );
  }
}

// Using the schema model
final userSchema = UserSchema(userData);
if (userSchema.isValid) {
  final user = userSchema.toModel();
}
```

### Key Differences

1. **Constructor Parameter**: Changed from `Map<String, dynamic>` to `Object?` for better flexibility
2. **Validation**: Happens automatically during construction instead of calling `validate()` explicitly
3. **Error Handling**: Use `isValid` and `getErrors()` instead of `validate().isOk` and `validate().getError()`
4. **Schema Definition**: Implement `getSchema()` instead of defining a static `schema` field
5. **Removed Methods**: `parse()`, `fromValidated()`, `validateMap()`, `validate()`, `createFromMap()`, and `initialize()` have been removed

## Best Practices

1. **Always Check Validity**: Always check `isValid` before calling `toModel()` to avoid exceptions
2. **Throw AckException**: Throw an `AckException` with the validation errors if `toModel()` is called on an invalid schema
3. **Use Type Parameters**: Use type parameters with `getValue<T>()` to ensure type safety
4. **Register Schemas**: Register schemas with `SchemaRegistry` to create them dynamically based on model types
